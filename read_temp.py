from machine import Pin
from machine import ADC
from machine import DAC
from math import log
import utime

adc_V_lookup = [0.04941177, 0.05558824, 0.1111765, 0.1152941, 0.1194118, 0.1235294, 0.1276471, 0.1317647, 0.1358824, 0.1389706, 0.1420588, 0.1451471, 0.1482353, 0.1513235, 0.1544118, 0.1575, 0.1605882, 0.1647059, 0.1688235, 0.1729412, 0.1770588, 0.1811765, 0.1852941, 0.1894118, 0.1935294, 0.1976471, 0.2007353, 0.2038235, 0.2069118, 0.21, 0.2141177, 0.2182353, 0.222353, 0.2254412, 0.2285294, 0.2316177, 0.2347059, 0.2388236, 0.2429412, 0.2470588, 0.2501471, 0.2532353, 0.2563236, 0.2594118, 0.2635294, 0.2676471, 0.2717647, 0.2758824, 0.28, 0.2841177, 0.2872059, 0.2902942, 0.2933824, 0.2964706, 0.3005883, 0.3047059, 0.3088235, 0.3119118, 0.315, 0.3180882, 0.3211765, 0.3242647, 0.327353, 0.3304412, 0.3335294, 0.3376471, 0.3417647, 0.3458824, 0.3489706, 0.3520588, 0.3551471, 0.3582353, 0.362353, 0.3664706, 0.3705883, 0.3736765, 0.3767647, 0.379853, 0.3829412, 0.3860294, 0.3891177, 0.3922059, 0.3952941, 0.4014706, 0.4076471, 0.4101177, 0.4125883, 0.4150588, 0.4175294, 0.42, 0.4241177, 0.4282353, 0.432353, 0.4354412, 0.4385294, 0.4416177, 0.4447059, 0.4488235, 0.4529412, 0.4570589, 0.4611764, 0.4652942, 0.4694118, 0.4725, 0.4755883, 0.4786765, 0.4817647, 0.4879412, 0.4941177, 0.4965883, 0.4990589, 0.5015294, 0.504, 0.5064706, 0.5095589, 0.5126471, 0.5157353, 0.5188236, 0.5229412, 0.5270588, 0.5311765, 0.5352941, 0.5394118, 0.5435295, 0.5466177, 0.5497059, 0.5527942, 0.5558824, 0.5583529, 0.5608235, 0.5632941, 0.5657647, 0.5682353, 0.5723529, 0.5764706, 0.5805883, 0.5847059, 0.5888236, 0.5929412, 0.5970588, 0.6011765, 0.6052941, 0.6094118, 0.6135294, 0.6176471, 0.6207353, 0.6238235, 0.6269117, 0.63, 0.6341177, 0.6382353, 0.642353, 0.6454412, 0.6485294, 0.6516176, 0.6547059, 0.6577941, 0.6608824, 0.6639706, 0.6670588, 0.6711765, 0.6752942, 0.6794118, 0.6835294, 0.6876471, 0.6917647, 0.6958824, 0.7, 0.7041177, 0.7082353, 0.712353, 0.7164706, 0.7189412, 0.7214118, 0.7238824, 0.7263529, 0.7288236, 0.7329412, 0.7370589, 0.7411765, 0.7442647, 0.747353, 0.7504412, 0.7535295, 0.757647, 0.7617648, 0.7658824, 0.7689706, 0.7720589, 0.7751471, 0.7782353, 0.7844118, 0.7905883, 0.7947059, 0.7988235, 0.8029412, 0.8060294, 0.8091177, 0.8122059, 0.8152942, 0.8183824, 0.8214706, 0.8245588, 0.8276471, 0.8301176, 0.8325883, 0.8350588, 0.8375295, 0.8400001, 0.8441177, 0.8482353, 0.852353, 0.8585295, 0.8647059, 0.8677941, 0.8708824, 0.8739706, 0.8770589, 0.8811766, 0.8852942, 0.8894118, 0.8918823, 0.894353, 0.8968235, 0.8992942, 0.9017648, 0.9058825, 0.91, 0.9141177, 0.9182354, 0.9223529, 0.9264707, 0.9295588, 0.9326471, 0.9357353, 0.9388236, 0.9429413, 0.9470588, 0.9511765, 0.9542647, 0.957353, 0.9604412, 0.9635295, 0.9676472, 0.9717647, 0.9758824, 0.9789706, 0.9820589, 0.9851471, 0.9882354, 0.9944118, 1.000588, 1.002647, 1.004706, 1.006765, 1.008824, 1.010882, 1.012941, 1.015412, 1.017882, 1.020353, 1.022824, 1.025294, 1.031471, 1.037647, 1.040735, 1.043824, 1.046912, 1.05, 1.054118, 1.058235, 1.062353, 1.065441, 1.068529, 1.071618, 1.074706, 1.078824, 1.082941, 1.087059, 1.090147, 1.093235, 1.096324, 1.099412, 1.103529, 1.107647, 1.111765, 1.114853, 1.117941, 1.121029, 1.124118, 1.128235, 1.132353, 1.136471, 1.139559, 1.142647, 1.145735, 1.148824, 1.152941, 1.157059, 1.161177, 1.164265, 1.167353, 1.170441, 1.17353, 1.176, 1.178471, 1.180941, 1.183412, 1.185882, 1.19, 1.194118, 1.198235, 1.201324, 1.204412, 1.2075, 1.210588, 1.213676, 1.216765, 1.219853, 1.222941, 1.227059, 1.231176, 1.235294, 1.239412, 1.243529, 1.247647, 1.250735, 1.253824, 1.256912, 1.26, 1.266176, 1.272353, 1.275441, 1.278529, 1.281618, 1.284706, 1.287794, 1.290882, 1.293971, 1.297059, 1.301177, 1.305294, 1.309412, 1.3125, 1.315588, 1.318676, 1.321765, 1.324853, 1.327941, 1.331029, 1.334118, 1.338235, 1.342353, 1.346471, 1.349559, 1.352647, 1.355735, 1.358824, 1.362941, 1.367059, 1.371176, 1.375294, 1.379412, 1.383529, 1.387647, 1.391765, 1.395882, 1.398353, 1.400824, 1.403294, 1.405765, 1.408235, 1.412353, 1.416471, 1.420588, 1.424706, 1.428824, 1.432941, 1.436029, 1.439118, 1.442206, 1.445294, 1.448382, 1.451471, 1.454559, 1.457647, 1.460735, 1.463824, 1.466912, 1.47, 1.473088, 1.476177, 1.479265, 1.482353, 1.486471, 1.490588, 1.494706, 1.497794, 1.500882, 1.503971, 1.507059, 1.511177, 1.515294, 1.519412, 1.5225, 1.525588, 1.528677, 1.531765, 1.535882, 1.54, 1.544118, 1.547206, 1.550294, 1.553382, 1.556471, 1.560588, 1.564706, 1.568824, 1.570196, 1.571569, 1.572941, 1.574314, 1.575686, 1.577059, 1.578432, 1.579804, 1.581177, 1.587353, 1.593529, 1.597647, 1.601765, 1.605882, 1.608971, 1.612059, 1.615147, 1.618235, 1.621324, 1.624412, 1.6275, 1.630588, 1.633677, 1.636765, 1.639853, 1.642941, 1.647059, 1.651177, 1.655294, 1.659412, 1.663529, 1.667647, 1.670735, 1.673824, 1.676912, 1.68, 1.684118, 1.688235, 1.692353, 1.695441, 1.698529, 1.701618, 1.704706, 1.707794, 1.710882, 1.713971, 1.717059, 1.721177, 1.725294, 1.729412, 1.7325, 1.735588, 1.738677, 1.741765, 1.747941, 1.754118, 1.756588, 1.759059, 1.76153, 1.764, 1.766471, 1.770588, 1.774706, 1.778824, 1.781912, 1.785, 1.788088, 1.791177, 1.795294, 1.799412, 1.80353, 1.807647, 1.811765, 1.815882, 1.82, 1.824118, 1.828235, 1.832353, 1.836471, 1.840588, 1.843677, 1.846765, 1.849853, 1.852941, 1.85603, 1.859118, 1.862206, 1.865294, 1.868382, 1.871471, 1.874559, 1.877647, 1.881765, 1.885882, 1.89, 1.893088, 1.896177, 1.899265, 1.902353, 1.905441, 1.908529, 1.911618, 1.914706, 1.917794, 1.920882, 1.923971, 1.927059, 1.931176, 1.935294, 1.939412, 1.945588, 1.951765, 1.954853, 1.957941, 1.96103, 1.964118, 1.966588, 1.969059, 1.97153, 1.974, 1.976471, 1.979559, 1.982647, 1.985735, 1.988824, 1.992941, 1.997059, 2.001177, 2.005294, 2.009412, 2.01353, 2.016618, 2.019706, 2.022794, 2.025882, 2.028971, 2.032059, 2.035147, 2.038235, 2.042353, 2.046471, 2.050588, 2.053677, 2.056765, 2.059853, 2.062941, 2.069118, 2.075294, 2.078382, 2.081471, 2.084559, 2.087647, 2.091765, 2.095882, 2.1, 2.103088, 2.106177, 2.109265, 2.112353, 2.115441, 2.11853, 2.121618, 2.124706, 2.128824, 2.132941, 2.137059, 2.140147, 2.143235, 2.146324, 2.149412, 2.153529, 2.157647, 2.161765, 2.165882, 2.17, 2.174118, 2.177206, 2.180294, 2.183383, 2.186471, 2.189559, 2.192647, 2.195735, 2.198824, 2.211177, 2.213235, 2.215294, 2.217353, 2.219412, 2.221471, 2.22353, 2.227647, 2.231765, 2.235883, 2.24, 2.244118, 2.248235, 2.251324, 2.254412, 2.2575, 2.260588, 2.264706, 2.268824, 2.272941, 2.27603, 2.279118, 2.282206, 2.285294, 2.288383, 2.291471, 2.294559, 2.297647, 2.301765, 2.305882, 2.31, 2.313088, 2.316177, 2.319265, 2.322353, 2.325441, 2.32853, 2.331618, 2.334706, 2.337177, 2.339647, 2.342118, 2.344588, 2.347059, 2.351177, 2.355294, 2.359412, 2.3625, 2.365588, 2.368677, 2.371765, 2.377941, 2.384118, 2.386588, 2.389059, 2.39153, 2.394, 2.396471, 2.402647, 2.408823, 2.410882, 2.412941, 2.415, 2.417059, 2.419118, 2.421176, 2.427353, 2.433529, 2.436618, 2.439706, 2.442794, 2.445882, 2.45, 2.454118, 2.458235, 2.461323, 2.464412, 2.4675, 2.470588, 2.473676, 2.476765, 2.479853, 2.482941, 2.486029, 2.489118, 2.492206, 2.495294, 2.497353, 2.499412, 2.501471, 2.50353, 2.505588, 2.507647, 2.511765, 2.515882, 2.52, 2.524118, 2.528235, 2.532353, 2.534824, 2.537294, 2.539765, 2.542235, 2.544706, 2.547177, 2.549647, 2.552118, 2.554588, 2.557059, 2.569412, 2.571882, 2.574353, 2.576824, 2.579294, 2.581765, 2.584235, 2.586706, 2.589177, 2.591647, 2.594118, 2.597206, 2.600294, 2.603382, 2.606471, 2.60853, 2.610588, 2.612647, 2.614706, 2.616765, 2.618824, 2.625, 2.631176, 2.634265, 2.637353, 2.640441, 2.643529, 2.646, 2.648471, 2.650941, 2.653412, 2.655882, 2.658971, 2.662059, 2.665147, 2.668235, 2.671324, 2.674412, 2.6775, 2.680588, 2.682647, 2.684706, 2.686765, 2.688824, 2.690882, 2.692941, 2.695412, 2.697882, 2.700353, 2.702824, 2.705294, 2.708382, 2.711471, 2.714559, 2.717647, 2.719706, 2.721765, 2.723824, 2.725883, 2.727941, 2.73, 2.732471, 2.734941, 2.737412, 2.739882, 2.742353, 2.744412, 2.746471, 2.748529, 2.750588, 2.752647, 2.754706, 2.757794, 2.760882, 2.763971, 2.767059, 2.768824, 2.770588, 2.772353, 2.774118, 2.775882, 2.777647, 2.779412, 2.7825, 2.785588, 2.788677, 2.791765, 2.793824, 2.795882, 2.797941, 2.8, 2.802059, 2.804118, 2.805882, 2.807647, 2.809412, 2.811176, 2.812941, 2.814706, 2.816471, 2.818941, 2.821412, 2.823883, 2.826353, 2.828824, 2.835, 2.841177, 2.842941, 2.844706, 2.846471, 2.848235, 2.85, 2.851765, 2.853529, 2.856, 2.858471, 2.860941, 2.863412, 2.865882, 2.867647, 2.869412, 2.871177, 2.872941, 2.874706, 2.876471, 2.878235, 2.880706, 2.883177, 2.885647, 2.888118, 2.890588, 2.892353, 2.894118, 2.895882, 2.897647, 2.899412, 2.901177, 2.902941, 2.905412, 2.907882, 2.910353, 2.912824, 2.915294, 2.917059, 2.918824, 2.920588, 2.922353, 2.924118, 2.925883, 2.927647, 2.930735, 2.933824, 2.936912, 2.94, 2.941544, 2.943088, 2.944633, 2.946177, 2.947721, 2.949265, 2.950809, 2.952353, 2.955441, 2.958529, 2.961618, 2.964706, 2.966765, 2.968824, 2.970882, 2.972941, 2.975, 2.977059, 2.978824, 2.980588, 2.982353, 2.984118, 2.985882, 2.987647, 2.989412, 2.991177, 2.992941, 2.994706, 2.996471, 2.998235, 3.0, 3.001765, 3.003309, 3.004853, 3.006397, 3.007941, 3.009485, 3.011029, 3.012574, 3.014118, 3.016177, 3.018235, 3.020294, 3.022353, 3.024412, 3.026471, 3.02853, 3.030588, 3.032647, 3.034706, 3.036765, 3.038824, 3.040883, 3.042941, 3.045, 3.047059, 3.049118, 3.051177, 3.052941, 3.054706, 3.056471, 3.058235, 3.06, 3.061765, 3.063529, 3.065588, 3.067647, 3.069706, 3.071765, 3.073823, 3.075882, 3.077647, 3.079412, 3.081177, 3.082941, 3.084706, 3.086471, 3.088235, 3.09, 3.091765, 3.093529, 3.095294, 3.097059, 3.098824, 3.100588, 3.102133, 3.103677, 3.105221, 3.106765, 3.108309, 3.109853, 3.111397, 3.112941, 3.114706, 3.116471, 3.118235, 3.12, 3.121765, 3.12353, 3.125294, 3.127059, 3.128824, 3.130588, 3.132353, 3.134118, 3.135883, 3.137647, 3.139191, 3.140735, 3.14228, 3.143824, 3.145368, 3.146912, 3.148456, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15, 3.15]
NOM_RES = 10000
SER_RES = 9820
TEMP_NOM = 25
NUM_SAMPLES = 25
THERM_B_COEFF = 3950
ADC_MAX = 1023
ADC_Vmax = 3.15

def init_temp_sensor(TENP_SENS_ADC_PIN_NO = 27):
    adc = ADC(Pin(TENP_SENS_ADC_PIN_NO))
    adc.atten(ADC.ATTN_11DB)
    adc.width(ADC.WIDTH_10BIT)
    return adc

def read_temp(temp_sens):
    raw_read = []
    # Collect NUM_SAMPLES
    for i in range(1, NUM_SAMPLES+1):
        raw_read.append(temp_sens.read())

    # Average of the NUM_SAMPLES and look it up in the table
    raw_average = sum(raw_read)/NUM_SAMPLES
    print('raw_avg = ' + str(raw_average))
    print('V_measured = ' + str(adc_V_lookup[round(raw_average)]))

    # Convert to resistance
    raw_average = ADC_MAX * adc_V_lookup[round(raw_average)]/ADC_Vmax
    resistance = (SER_RES * raw_average) / (ADC_MAX - raw_average)
    print('Thermistor resistance: {} ohms'.format(resistance))

    # Convert to temperatur
    steinhart  = log(resistance / NOM_RES) / THERM_B_COEFF
    steinhart += 1.0 / (TEMP_NOM + 273.15)
    steinhart  = (1.0 / steinhart) - 273.15
    return steinhart

print("initialization complete\n")
utime.sleep_ms(2000)

def change_pump_dir(dir):
    dir_pin1.value(dir)

def get_pump_dir():
    return  dir_pin1.value()

def update_pump(temp):
    if (get_pump_dir() != 1 and temp >= 18):
        change_pump_dir(1)
    else:
        change_pump_dir(0)

pid=[]
error=[]
TotalError = 0
while (True):
    if utime.ticks_diff(utime.ticks_ms(), sample_last_ms) >= SAMPLE_INTERVAL:
        temp = read_temp(temp_sens)
        
        # update_pump(temp)
        pid.append(temp)
        CurrentError= abs(18-temp)
        error.append(CurrentError)
        TotalError += CurrentError

        #TODO: connnect to PID temp control here
        print('Thermistor temperature: ' + str(temp))
        sample_last_ms = utime.ticks_ms()
        #TODO: 

